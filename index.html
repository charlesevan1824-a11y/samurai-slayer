<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>Samurai Slayer</title>
  <script src="https://cdn.tailwindcss.com/3.4.17"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Bebas+Neue&family=Noto+Serif+JP:wght@400;700&display=swap');
    :root { --gold:#fbbf24; --red:#dc2626; --crimson:#ff006e; --ink:#0a0a0a; }
    *{box-sizing:border-box;user-select:none;-webkit-user-select:none;touch-action:manipulation;}
    html,body{height:100%;width:100%;margin:0;padding:0;overflow:hidden;background:#000;}
    #root{height:100%;width:100%;display:flex;flex-direction:column;}
    .samurai-font{font-family:'Orbitron',sans-serif;}
    .title-font{font-family:'Bebas Neue',cursive;letter-spacing:3px;}
    .jp-font{font-family:'Noto Serif JP',serif;}
    .neon-glow{text-shadow:0 0 10px currentColor,0 0 25px currentColor,0 0 50px currentColor;}
    .gold-glow{text-shadow:0 0 10px #fbbf24,0 0 25px #fbbf24,0 0 50px #f59e0b;}
    .red-glow{text-shadow:0 0 10px #dc2626,0 0 25px #dc2626,0 0 50px #b91c1c;}
    .game-bg-img{background-image:url("BGimg.jpg");background-size:cover;background-position:center;}
    .screen{position:absolute;inset:0;display:none;flex-direction:column;}
    .screen.active{display:flex;}
    .screen-scroll{overflow-y:auto;-webkit-overflow-scrolling:touch;}
    .bg-overlay{position:absolute;inset:0;background:linear-gradient(to bottom,rgba(0,0,0,0.55) 0%,rgba(0,0,0,0.75) 100%);}

    /* ‚îÄ‚îÄ WEAPON SLASH ANIMATIONS ‚îÄ‚îÄ */
    .slash-katana{
      position:absolute;pointer-events:none;z-index:20;
      width:80px;height:6px;border-radius:3px;
      background:linear-gradient(90deg,rgba(192,192,255,0.9),rgba(255,255,255,1),rgba(150,150,255,0.4));
      box-shadow:0 0 8px #aaf,0 0 20px #fff;
      transform-origin:left center;
      animation:katanaSlash 0.45s forwards;
    }
    @keyframes katanaSlash{
      0%{opacity:1;transform:scaleX(0) rotate(-30deg) translateY(-10px);}
      30%{opacity:1;transform:scaleX(1.2) rotate(10deg) translateY(5px);}
      100%{opacity:0;transform:scaleX(0.8) rotate(40deg) translateY(-30px);}
    }
    .slash-flame{
      position:absolute;pointer-events:none;z-index:20;font-size:2.5rem;
      animation:flameSlash 0.55s forwards;
    }
    @keyframes flameSlash{
      0%{opacity:1;transform:scale(0.3) rotate(-20deg);}
      40%{opacity:1;transform:scale(1.4) rotate(10deg);}
      100%{opacity:0;transform:scale(0.5) rotate(30deg) translateY(-60px);}
    }
    .slash-frost{
      position:absolute;pointer-events:none;z-index:20;font-size:2.5rem;
      animation:frostSlash 0.6s forwards;
    }
    @keyframes frostSlash{
      0%{opacity:1;transform:scale(0.2) rotate(-30deg);}
      35%{opacity:1;transform:scale(1.3) rotate(0deg);}
      100%{opacity:0;transform:scale(0.7) rotate(20deg) translateY(-50px);}
    }
    .slash-dark{
      position:absolute;pointer-events:none;z-index:20;
      width:70px;height:70px;border-radius:50%;
      background:radial-gradient(circle,rgba(80,0,120,0.9),rgba(20,0,40,0.5),transparent);
      box-shadow:0 0 20px #a855f7,0 0 40px #7c3aed;
      animation:darkSlash 0.5s forwards;
    }
    @keyframes darkSlash{
      0%{opacity:1;transform:scale(0.2);}
      40%{opacity:1;transform:scale(1.5);}
      100%{opacity:0;transform:scale(0.3) translateY(-40px);}
    }

    /* Flame aura on enemy */
    .flame-aura{animation:flameAura 0.3s forwards;}
    @keyframes flameAura{0%{filter:brightness(1) saturate(1);}50%{filter:brightness(3) saturate(3) hue-rotate(30deg);}100%{filter:brightness(1) saturate(1);}}
    .frost-aura{animation:frostAura 0.3s forwards;}
    @keyframes frostAura{0%{filter:brightness(1);}50%{filter:brightness(2) saturate(0) hue-rotate(200deg);}100%{filter:brightness(1);}}
    .dark-aura{animation:darkAura 0.3s forwards;}
    @keyframes darkAura{0%{filter:brightness(1);}50%{filter:brightness(0.3) saturate(3) hue-rotate(270deg);}100%{filter:brightness(1);}}

    /* ‚îÄ‚îÄ COMBO / EFFECTS ‚îÄ‚îÄ */
    .combo-pop{position:absolute;font-family:'Bebas Neue',cursive;font-size:clamp(1.5rem,4vw,2.2rem);pointer-events:none;animation:comboPop 0.8s forwards;z-index:20;}
    @keyframes comboPop{0%{opacity:0;transform:scale(0.5) translateY(0);}30%{opacity:1;transform:scale(1.3) translateY(-20px);}100%{opacity:0;transform:scale(0.8) translateY(-80px);}}
    .levelup-burst{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;pointer-events:none;z-index:100;animation:levelBg 1.4s forwards;}
    @keyframes levelBg{0%,100%{background:transparent;}30%{background:rgba(251,191,36,0.18);}}
    .levelup-text{font-family:'Bebas Neue',cursive;font-size:clamp(3rem,10vw,5rem);color:#fbbf24;letter-spacing:4px;text-shadow:0 0 30px #fbbf24,0 0 60px #fbbf24;animation:levelTextPop 1.4s forwards;}
    @keyframes levelTextPop{0%{transform:scale(0.3);opacity:0;}20%{transform:scale(1.2);opacity:1;}60%{transform:scale(1);opacity:1;}100%{transform:scale(1.5);opacity:0;}}
    .you-lose-overlay{position:fixed;inset:0;background:rgba(180,0,0,0.75);display:flex;align-items:center;justify-content:center;z-index:200;}
    .you-lose-text{font-family:'Bebas Neue',cursive;font-size:clamp(4rem,15vw,8rem);color:#fff;letter-spacing:4px;text-shadow:0 0 30px #ff0000,0 0 60px #ff0000;animation:loseBounce 0.6s cubic-bezier(0.68,-0.55,0.265,1.55);}
    @keyframes loseBounce{0%{transform:scale(0.4) translateY(-80px);}60%{transform:scale(1.1) translateY(10px);}100%{transform:scale(1) translateY(0);}}
    .countdown-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.88);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:150;}
    .countdown-number{font-family:'Bebas Neue',cursive;font-size:clamp(6rem,20vw,10rem);letter-spacing:4px;animation:countPop 0.5s cubic-bezier(0.68,-0.55,0.265,1.55);}
    @keyframes countPop{0%{transform:scale(0.3);opacity:0;}60%{transform:scale(1.2);opacity:1;}100%{transform:scale(1);opacity:1;}}
    .instructions-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.92);display:flex;align-items:center;justify-content:center;z-index:140;overflow-y:auto;padding:16px;}
    .damage-flash{position:fixed;inset:0;pointer-events:none;z-index:90;background:radial-gradient(ellipse at center,transparent 30%,rgba(200,0,0,0.65) 100%);animation:damageAnim 0.5s forwards;}
    @keyframes damageAnim{0%{opacity:1;}100%{opacity:0;}}
    @keyframes screenShake{0%,100%{transform:translate(0,0);}20%{transform:translate(-6px,3px);}40%{transform:translate(6px,-3px);}60%{transform:translate(-4px,4px);}80%{transform:translate(4px,-2px);}}
    .shaking{animation:screenShake 0.4s;}
    @keyframes fadeIn{from{opacity:0;}to{opacity:1;}}
    .fade-in{animation:fadeIn 0.6s both;}
    @keyframes slideUp{from{opacity:0;transform:translateY(30px);}to{opacity:1;transform:translateY(0);}}
    .slide-up{animation:slideUp 0.5s both;}
    .rank-badge{display:inline-block;padding:3px 12px;border-radius:20px;font-weight:bold;font-size:0.8rem;}
    .rank-novice{background:#475569;color:#fff;}
    .rank-warrior{background:#ea580c;color:#fff;}
    .rank-master{background:#fbbf24;color:#000;}
    .rank-legendary{background:#ff006e;color:#fff;}
    .persona-card{transition:all 0.3s;border:2px solid rgba(255,255,255,0.15);border-radius:12px;}
    .persona-card:hover{transform:scale(1.04);border-color:#fbbf24;}
    .persona-card:active{transform:scale(0.97);}
    .persona-card.selected{border-color:#ff006e;box-shadow:0 0 20px rgba(255,0,110,0.5);}
    .stat-bar-bg{background:rgba(255,255,255,0.15);border-radius:4px;height:6px;overflow:hidden;}
    .stat-bar-fill{height:100%;border-radius:4px;transition:width 0.6s;}
    .btn-main{font-family:'Orbitron',sans-serif;font-size:clamp(0.75rem,2.5vw,1rem);padding:clamp(10px,2vw,16px) clamp(20px,4vw,32px);border-radius:8px;font-weight:700;width:clamp(200px,70vw,280px);transform:translateY(0);transition:transform 0.15s,filter 0.15s;border:none;cursor:pointer;}
    .btn-main:hover{transform:translateY(-2px) scale(1.03);filter:brightness(1.1);}
    .btn-main:active{transform:scale(0.96);}
    .powerup-pill{font-family:'Orbitron',sans-serif;font-size:clamp(0.6rem,1.5vw,0.8rem);padding:3px 10px;border-radius:20px;font-weight:700;animation:pillPulse 0.5s infinite alternate;}
    @keyframes pillPulse{0%{filter:brightness(1);}100%{filter:brightness(1.5);}}
    #pause-btn{position:absolute;top:8px;right:8px;z-index:50;font-family:'Orbitron',sans-serif;font-size:clamp(0.6rem,1.5vw,0.75rem);padding:5px 12px;background:rgba(0,0,0,0.5);color:#fff;border:1px solid rgba(255,255,255,0.3);border-radius:6px;}
    .usability-pill{display:inline-block;padding:4px 14px;border-radius:20px;font-size:clamp(0.7rem,1.8vw,0.85rem);font-weight:700;font-family:'Orbitron',sans-serif;margin-bottom:8px;}
    .shop-item{transition:all 0.25s;border-radius:10px;cursor:pointer;}
    .shop-item:hover{transform:translateY(-4px);}
    .shop-item.equipped{box-shadow:inset 0 0 14px rgba(251,191,36,0.4);}
    .pause-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.88);display:flex;align-items:center;justify-content:center;z-index:120;}
    .lvl-bg-1{background:linear-gradient(to bottom,rgba(13,43,69,0.9),rgba(5,15,25,0.95));}
    .lvl-bg-2{background:linear-gradient(to bottom,rgba(70,10,10,0.9),rgba(25,5,5,0.95));}
    .lvl-bg-3{background:linear-gradient(to bottom,rgba(40,10,60,0.9),rgba(15,5,25,0.95));}
    .lvl-bg-4{background:linear-gradient(to bottom,rgba(60,10,30,0.9),rgba(25,5,10,0.95));}
    .lvl-bg-5{background:linear-gradient(to bottom,rgba(60,30,10,0.9),rgba(25,10,5,0.95));}
    .text-resp-sm{font-size:clamp(0.7rem,2vw,0.9rem);}
    .text-resp-md{font-size:clamp(0.9rem,2.5vw,1.1rem);}
    .text-resp-xl{font-size:clamp(1.5rem,5vw,2.5rem);}
    .text-resp-2xl{font-size:clamp(2.5rem,8vw,4.5rem);}
    .text-resp-3xl{font-size:clamp(3.5rem,12vw,7rem);}
    .touch-target{min-height:44px;min-width:44px;}
    ::-webkit-scrollbar{width:4px;}
    ::-webkit-scrollbar-thumb{background:rgba(251,191,36,0.4);border-radius:4px;}
    .star-wrap{display:flex;gap:6px;justify-content:center;margin:8px 0;}
    .star{font-size:clamp(1.6rem,5vw,2.2rem);filter:grayscale(1) brightness(0.4);transition:filter 0.3s,transform 0.3s;}
    .star.lit{filter:grayscale(0) brightness(1.2) drop-shadow(0 0 8px #fbbf24);animation:starPop 0.4s cubic-bezier(0.68,-0.55,0.265,1.55) both;}
    @keyframes starPop{0%{transform:scale(0.3) rotate(-20deg);}60%{transform:scale(1.3) rotate(5deg);}100%{transform:scale(1) rotate(0deg);}}

    /* ‚îÄ‚îÄ PROFILE AVATAR in HUD ‚îÄ‚îÄ */
    .hud-avatar{width:38px;height:38px;border-radius:50%;border:2px solid #fbbf24;object-fit:cover;background:#1a1a2e;}
    .hud-profile{display:flex;align-items:center;gap:6px;}

    /* ‚îÄ‚îÄ HUD weapon badge ‚îÄ‚îÄ */
    .hud-weapon{font-size:1.3rem;line-height:1;}

    /* ‚îÄ‚îÄ User personas display ‚îÄ‚îÄ */
    .user-persona-card{transition:all 0.3s;border:2px solid rgba(255,255,255,0.2);border-radius:16px;cursor:pointer;}
    .user-persona-card:hover{transform:scale(1.04);border-color:#fbbf24;}
    .user-persona-card.selected{border-color:#ff006e;box-shadow:0 0 25px rgba(255,0,110,0.6);}

    /* ‚îÄ‚îÄ Login Modal ‚îÄ‚îÄ */
    .login-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.95);display:flex;align-items:center;justify-content:center;z-index:300;padding:16px;}
    .login-card{background:linear-gradient(135deg,#0f0f1e,#1a1a2e);border:2px solid rgba(251,191,36,0.5);border-radius:20px;padding:clamp(20px,5vw,36px);max-width:440px;width:100%;}

    /* ‚îÄ‚îÄ Avatar image fallback ‚îÄ‚îÄ */
    .avatar-img{width:100%;height:100%;object-fit:cover;border-radius:50%;}
    .avatar-placeholder{width:100%;height:100%;display:flex;align-items:center;justify-content:center;font-size:1.8rem;background:linear-gradient(135deg,#1a1a2e,#0f0f1e);border-radius:50%;}

    /* ‚îÄ‚îÄ Weapon select highlight ‚îÄ‚îÄ */
    .weapon-active{border-color:#fbbf24 !important;box-shadow:0 0 15px rgba(251,191,36,0.5);}
    .skin-active{border-color:#ff006e !important;box-shadow:0 0 15px rgba(255,0,110,0.5);}
    .clothes-active{border-color:#a855f7 !important;box-shadow:0 0 15px rgba(168,85,247,0.5);}

    /* Persona profile ring */
    .profile-ring{
      width:70px;height:70px;border-radius:50%;border:3px solid #fbbf24;
      display:flex;align-items:center;justify-content:center;
      overflow:hidden;background:#111;flex-shrink:0;
    }
    .profile-ring img{width:100%;height:100%;object-fit:cover;}
    .profile-ring-fallback{font-size:2rem;}

    @media (orientation:landscape) and (max-height:500px){
      .landscape-compact{padding-top:4px;padding-bottom:4px;}
      .landscape-hide{display:none !important;}
    }
  </style>
</head>
<body>
<audio id="bgm-open" src="bgm-open-page.mp3" loop></audio>
<audio id="bgm"      src="your-music.mp3"    loop></audio>
<audio id="sfx-slice"   src="slash.mp3"></audio>
<audio id="sfx-bomb"    src="explosion.mp3"></audio>
<audio id="sfx-combo"   src="combo.mp3"></audio>
<audio id="sfx-levelup" src="levelup.mp3"></audio>
<audio id="sfx-powerup" src="powerup.mp3"></audio>
<audio id="sfx-click"   src="click.mp3"></audio>

<div id="root">

  <!-- ===== LOGIN / USER SELECT ===== -->
  <div id="screen-login" class="screen active" style="background:linear-gradient(135deg,#0a0a14,#0f0f2e);">
    <div class="relative z-10 flex flex-col items-center justify-center h-full px-4">
      <div style="text-align:center;margin-bottom:24px;">
        <h1 class="title-font text-resp-3xl text-red-500 gold-glow leading-none">SAMURAI</h1>
        <h2 class="title-font text-resp-2xl text-yellow-400 gold-glow leading-none">SLAYER</h2>
        <p class="jp-font text-yellow-600/70 text-sm mt-1">‰æç„ÅÆÈÅì ‚Äî The Way of the Samurai</p>
      </div>

      <div style="background:linear-gradient(135deg,#0f0f1e,#1a1a2e);border:2px solid rgba(251,191,36,0.4);border-radius:20px;padding:clamp(16px,4vw,28px);max-width:460px;width:100%;">
        <h3 class="samurai-font text-yellow-400 font-bold text-center mb-4" style="font-size:clamp(0.8rem,2.5vw,1rem);">SELECT YOUR WARRIOR</h3>

        <!-- 3 User Persona Cards -->
        <div id="login-persona-grid" style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:20px;">
          <!-- Persona 1 -->
          <div class="user-persona-card bg-black/60 p-3 text-center" data-uid="1" onclick="selectLoginPersona(1)" style="position:relative;">
            <button onclick="openEditProfile(1,event)" title="Edit profile" style="position:absolute;top:6px;right:6px;width:22px;height:22px;background:rgba(251,191,36,0.2);border:1px solid rgba(251,191,36,0.5);border-radius:50%;color:#fbbf24;font-size:0.65rem;cursor:pointer;display:flex;align-items:center;justify-content:center;z-index:5;">‚úèÔ∏è</button>
            <div style="width:64px;height:64px;border-radius:50%;margin:0 auto 8px;border:2px solid rgba(251,191,36,0.4);overflow:hidden;background:#111;">
              <img src="userpersona1.png" alt="Persona 1" style="width:100%;height:100%;object-fit:cover;" onerror="this.style.display='none';this.nextElementSibling.style.display='flex';">
              <div style="display:none;width:100%;height:100%;align-items:center;justify-content:center;font-size:1.8rem;">ü•∑</div>
            </div>
            <p class="samurai-font text-cyan-400 font-bold" style="font-size:0.65rem;" id="lp1-name">SHADOW</p>
            <p class="text-gray-500" style="font-size:0.6rem;" id="lp1-score">Best: 0</p>
          </div>
          <!-- Persona 2 -->
          <div class="user-persona-card bg-black/60 p-3 text-center" data-uid="2" onclick="selectLoginPersona(2)" style="position:relative;">
            <button onclick="openEditProfile(2,event)" title="Edit profile" style="position:absolute;top:6px;right:6px;width:22px;height:22px;background:rgba(251,191,36,0.2);border:1px solid rgba(251,191,36,0.5);border-radius:50%;color:#fbbf24;font-size:0.65rem;cursor:pointer;display:flex;align-items:center;justify-content:center;z-index:5;">‚úèÔ∏è</button>
            <div style="width:64px;height:64px;border-radius:50%;margin:0 auto 8px;border:2px solid rgba(251,191,36,0.4);overflow:hidden;background:#111;">
              <img src="userpersona2.jpg" alt="Persona 2" style="width:100%;height:100%;object-fit:cover;" onerror="this.style.display='none';this.nextElementSibling.style.display='flex';">
              <div style="display:none;width:100%;height:100%;align-items:center;justify-content:center;font-size:1.8rem;">üí™</div>
            </div>
            <p class="samurai-font text-red-400 font-bold" style="font-size:0.65rem;" id="lp2-name">BLAZE</p>
            <p class="text-gray-500" style="font-size:0.6rem;" id="lp2-score">Best: 0</p>
          </div>
          <!-- Persona 3 -->
          <div class="user-persona-card bg-black/60 p-3 text-center" data-uid="3" onclick="selectLoginPersona(3)" style="position:relative;">
            <button onclick="openEditProfile(3,event)" title="Edit profile" style="position:absolute;top:6px;right:6px;width:22px;height:22px;background:rgba(251,191,36,0.2);border:1px solid rgba(251,191,36,0.5);border-radius:50%;color:#fbbf24;font-size:0.65rem;cursor:pointer;display:flex;align-items:center;justify-content:center;z-index:5;">‚úèÔ∏è</button>
            <div style="width:64px;height:64px;border-radius:50%;margin:0 auto 8px;border:2px solid rgba(251,191,36,0.4);overflow:hidden;background:#111;">
              <img src="userpersona3.png" alt="Persona 3" style="width:100%;height:100%;object-fit:cover;" onerror="this.style.display='none';this.nextElementSibling.style.display='flex';">
              <div style="display:none;width:100%;height:100%;align-items:center;justify-content:center;font-size:1.8rem;">üõ°Ô∏è</div>
            </div>
            <p class="samurai-font text-yellow-400 font-bold" style="font-size:0.65rem;" id="lp3-name">GUARDIAN</p>
            <p class="text-gray-500" style="font-size:0.6rem;" id="lp3-score">Best: 0</p>
          </div>
        </div>

        <!-- Username input -->
        <div style="margin-bottom:14px;">
          <label class="samurai-font text-gray-400" style="font-size:0.7rem;display:block;margin-bottom:6px;">‚úèÔ∏è USERNAME</label>
          <input id="login-username" type="text" maxlength="16" placeholder="Enter your name..."
            style="width:100%;background:rgba(255,255,255,0.08);border:1px solid rgba(251,191,36,0.3);border-radius:8px;color:#fff;padding:10px 14px;font-family:'Orbitron',sans-serif;font-size:0.85rem;outline:none;"
            oninput="updateLoginPreview()">
        </div>

        <button onclick="confirmLogin()" id="login-confirm-btn"
          style="width:100%;padding:14px;background:linear-gradient(to right,#dc2626,#fbbf24);color:#fff;border:none;border-radius:10px;font-family:'Orbitron',sans-serif;font-weight:700;font-size:0.9rem;cursor:pointer;opacity:0.5;" disabled>
          ‚öîÔ∏è ENTER THE BATTLEFIELD
        </button>
      </div>

      <p class="text-gray-600 samurai-font mt-4" style="font-size:0.65rem;">Select a warrior profile & enter your name to continue</p>
    </div>
  </div>

  <!-- ===== MAIN MENU ===== -->
  <div id="screen-main" class="screen game-bg-img" style="cursor:crosshair;">
    <div class="bg-overlay"></div>
    <div class="absolute inset-0 pointer-events-none overflow-hidden z-0">
      <div class="absolute top-4 left-4 jp-font text-5xl text-yellow-600/20">‰æç</div>
      <div class="absolute top-4 right-4 jp-font text-5xl text-red-800/20">Êñ¨</div>
      <div class="absolute bottom-16 left-8 jp-font text-4xl text-yellow-700/15">ÈÅì</div>
    </div>
    <div class="relative z-10 flex flex-col items-center justify-center h-full px-4">
      <div class="text-center mb-4 fade-in">
        <h1 class="title-font text-resp-3xl text-red-500 gold-glow leading-none">SAMURAI</h1>
        <h2 class="title-font text-resp-2xl text-yellow-400 gold-glow leading-none">SLAYER</h2>
        <p class="jp-font text-yellow-600/70 text-sm mt-1">‰æç„ÅÆÈÅì ‚Äî The Way of the Samurai</p>
      </div>
      <div class="flex flex-col items-center gap-3 w-full">
        <button id="btn-play"        class="btn-main slide-up bg-gradient-to-r from-red-700 to-red-600 text-white" style="animation-delay:0.1s">‚ñ∂ START BATTLE</button>
        <button id="btn-usability"   class="btn-main slide-up bg-gradient-to-r from-green-800 to-green-700 text-white" style="animation-delay:0.2s">üìö USABILITY GUIDE</button>
        <button id="btn-shop"        class="btn-main slide-up bg-gradient-to-r from-yellow-700 to-yellow-600 text-black" style="animation-delay:0.3s">üõç SHOP</button>
        <button id="btn-leaderboard" class="btn-main slide-up bg-gradient-to-r from-purple-800 to-purple-700 text-white" style="animation-delay:0.4s">üìä LEADERBOARD</button>
        <button id="btn-settings"    class="btn-main slide-up bg-gradient-to-r from-gray-700 to-gray-600 text-white" style="animation-delay:0.5s">‚öô SETTINGS</button>
      </div>
      <div id="player-preview" class="mt-4 text-center"></div>
    </div>
  </div>

  <!-- ===== CHARACTER SELECT ===== -->
  <div id="screen-character" class="screen game-bg-img screen-scroll" style="cursor:crosshair;">
    <div class="bg-overlay"></div>
    <div class="relative z-10 flex flex-col items-center px-4 py-6 min-h-full">
      <h2 class="title-font text-resp-2xl text-yellow-400 gold-glow mb-1">CHOOSE YOUR PERSONA</h2>
      <p class="text-gray-400 text-resp-sm samurai-font mb-6">Each warrior has a unique fighting style</p>
      <div id="persona-grid" class="grid grid-cols-1 gap-4 w-full max-w-3xl mb-6" style="grid-template-columns:repeat(auto-fit,minmax(200px,1fr));">
        <div class="persona-card bg-black/60 backdrop-blur p-4 text-center" data-persona="ninja">
          <div class="text-5xl mb-2">ü•∑</div>
          <h3 class="samurai-font text-cyan-400 font-bold text-resp-md mb-1">NINJA</h3>
          <p class="text-gray-400 text-xs italic mb-3">"Swift and deadly"</p>
          <div class="space-y-2 text-left mb-3">
            <div><div class="flex justify-between text-xs mb-1"><span class="text-red-400">‚öîÔ∏è Power</span><span class="text-white">7/10</span></div><div class="stat-bar-bg"><div class="stat-bar-fill bg-red-500" style="width:70%"></div></div></div>
            <div><div class="flex justify-between text-xs mb-1"><span class="text-blue-400">üõ°Ô∏è Defense</span><span class="text-white">6/10</span></div><div class="stat-bar-bg"><div class="stat-bar-fill bg-blue-500" style="width:60%"></div></div></div>
            <div><div class="flex justify-between text-xs mb-1"><span class="text-green-400">‚ö° Speed</span><span class="text-white">9/10</span></div><div class="stat-bar-bg"><div class="stat-bar-fill bg-green-500" style="width:90%"></div></div></div>
          </div>
          <div class="bg-cyan-900/30 border border-cyan-700/40 rounded-lg p-2 mb-3 text-left">
            <p class="text-cyan-400 text-xs font-bold mb-1 samurai-font">USABILITY TRAITS</p>
            <p class="text-gray-300 text-xs">‚ö° <b>Learnability</b>: Predictable strike patterns</p>
            <p class="text-gray-300 text-xs">üéØ <b>Flexibility</b>: Customizable combo chains</p>
          </div>
          <button class="samurai-font w-full py-2 bg-cyan-700 hover:bg-cyan-600 text-white rounded-lg font-bold text-xs touch-target">SELECT</button>
        </div>
        <div class="persona-card bg-black/60 backdrop-blur p-4 text-center" data-persona="berserker">
          <div class="text-5xl mb-2">üí™</div>
          <h3 class="samurai-font text-red-400 font-bold text-resp-md mb-1">BERSERKER</h3>
          <p class="text-gray-400 text-xs italic mb-3">"Raw overwhelming force"</p>
          <div class="space-y-2 text-left mb-3">
            <div><div class="flex justify-between text-xs mb-1"><span class="text-red-400">‚öîÔ∏è Power</span><span class="text-white">10/10</span></div><div class="stat-bar-bg"><div class="stat-bar-fill bg-red-500" style="width:100%"></div></div></div>
            <div><div class="flex justify-between text-xs mb-1"><span class="text-blue-400">üõ°Ô∏è Defense</span><span class="text-white">5/10</span></div><div class="stat-bar-bg"><div class="stat-bar-fill bg-blue-500" style="width:50%"></div></div></div>
            <div><div class="flex justify-between text-xs mb-1"><span class="text-green-400">‚ö° Speed</span><span class="text-white">6/10</span></div><div class="stat-bar-bg"><div class="stat-bar-fill bg-green-500" style="width:60%"></div></div></div>
          </div>
          <div class="bg-red-900/30 border border-red-700/40 rounded-lg p-2 mb-3 text-left">
            <p class="text-red-400 text-xs font-bold mb-1 samurai-font">USABILITY TRAITS</p>
            <p class="text-gray-300 text-xs">üí• <b>Robustness</b>: High error recovery rate</p>
            <p class="text-gray-300 text-xs">üî• <b>Learnability</b>: Familiar brute-force patterns</p>
          </div>
          <button class="samurai-font w-full py-2 bg-red-700 hover:bg-red-600 text-white rounded-lg font-bold text-xs touch-target">SELECT</button>
        </div>
        <div class="persona-card bg-black/60 backdrop-blur p-4 text-center" data-persona="guardian">
          <div class="text-5xl mb-2">üõ°Ô∏è</div>
          <h3 class="samurai-font text-yellow-400 font-bold text-resp-md mb-1">GUARDIAN</h3>
          <p class="text-gray-400 text-xs italic mb-3">"Unbreakable protector"</p>
          <div class="space-y-2 text-left mb-3">
            <div><div class="flex justify-between text-xs mb-1"><span class="text-red-400">‚öîÔ∏è Power</span><span class="text-white">6/10</span></div><div class="stat-bar-bg"><div class="stat-bar-fill bg-red-500" style="width:60%"></div></div></div>
            <div><div class="flex justify-between text-xs mb-1"><span class="text-blue-400">üõ°Ô∏è Defense</span><span class="text-white">10/10</span></div><div class="stat-bar-bg"><div class="stat-bar-fill bg-blue-500" style="width:100%"></div></div></div>
            <div><div class="flex justify-between text-xs mb-1"><span class="text-green-400">‚ö° Speed</span><span class="text-white">5/10</span></div><div class="stat-bar-bg"><div class="stat-bar-fill bg-green-500" style="width:50%"></div></div></div>
          </div>
          <div class="bg-yellow-900/30 border border-yellow-700/40 rounded-lg p-2 mb-3 text-left">
            <p class="text-yellow-400 text-xs font-bold mb-1 samurai-font">USABILITY TRAITS</p>
            <p class="text-gray-300 text-xs">üõ°Ô∏è <b>Robustness</b>: Max observability & recoverability</p>
            <p class="text-gray-300 text-xs">üîÑ <b>Flexibility</b>: Substitutive defense strategies</p>
          </div>
          <button class="samurai-font w-full py-2 bg-yellow-700 hover:bg-yellow-600 text-black rounded-lg font-bold text-xs touch-target">SELECT</button>
        </div>
      </div>
      <button id="back-from-character" class="samurai-font px-8 py-3 bg-gray-800/80 hover:bg-gray-700 text-white rounded-lg touch-target text-resp-sm">‚Üê BACK</button>
    </div>
  </div>

  <!-- ===== DIFFICULTY SELECT ===== -->
  <div id="screen-difficulty" class="screen game-bg-img" style="cursor:crosshair;">
    <div class="bg-overlay"></div>
    <div class="relative z-10 flex flex-col items-center justify-center h-full px-4">
      <h2 class="title-font text-resp-2xl text-yellow-400 gold-glow mb-2">SELECT DIFFICULTY</h2>
      <p class="text-gray-400 text-resp-sm samurai-font mb-8">Choose your path, warrior</p>
      <div class="flex flex-col items-center gap-4 w-full">
        <button class="difficulty-btn btn-main bg-gradient-to-r from-green-700 to-green-600 text-white" data-difficulty="normal">üåô NORMAL ‚Äî Beginner's Path</button>
        <button class="difficulty-btn btn-main bg-gradient-to-r from-orange-700 to-orange-600 text-white" data-difficulty="hard">üåÖ HARD ‚Äî Warrior's Challenge</button>
        <button class="difficulty-btn btn-main bg-gradient-to-r from-red-800 to-red-700 text-white" data-difficulty="insane">‚òÄÔ∏è INSANE ‚Äî Master's Test</button>
      </div>
      <button id="back-from-difficulty" class="samurai-font mt-8 px-8 py-3 bg-gray-800/80 hover:bg-gray-700 text-white rounded-lg touch-target text-resp-sm">‚Üê BACK</button>
    </div>
  </div>

  <!-- ===== GAMEPLAY ===== -->
  <div id="screen-gameplay" class="screen game-bg-img" style="cursor:crosshair;">
    <div id="level-overlay" class="absolute inset-0 lvl-bg-1 transition-all duration-1000"></div>
    <!-- HUD -->
    <div class="relative z-10 flex justify-between items-start px-3 pt-2 pb-1 pointer-events-none">
      <!-- Left: profile + persona info -->
      <div class="hud-profile">
        <div style="width:42px;height:42px;border-radius:50%;border:2px solid #fbbf24;overflow:hidden;background:#111;flex-shrink:0;" id="hud-avatar-wrap">
          <img id="hud-avatar-img" src="" alt="" style="width:100%;height:100%;object-fit:cover;" onerror="this.style.display='none';">
          <div id="hud-avatar-fallback" style="display:none;width:100%;height:100%;align-items:center;justify-content:center;font-size:1.4rem;background:#1a1a2e;"></div>
        </div>
        <div>
          <p class="samurai-font text-yellow-300 font-bold" style="font-size:clamp(0.6rem,1.8vw,0.8rem);" id="hud-username">SAMURAI</p>
          <p class="samurai-font text-gray-400" style="font-size:clamp(0.5rem,1.4vw,0.65rem);">
            <span id="hud-persona" class="text-cyan-400">NINJA</span>
            &nbsp;¬∑&nbsp;LVL <span id="hud-level" class="text-pink-400 font-bold">1</span>
          </p>
          <p class="samurai-font text-gray-500" style="font-size:clamp(0.45rem,1.2vw,0.6rem);">
            DIFF: <span id="hud-diff" class="text-red-400">NORMAL</span>
          </p>
        </div>
      </div>
      <!-- Center: score -->
      <div class="text-center">
        <p class="samurai-font font-black text-yellow-400" style="font-size:clamp(1.5rem,5vw,2.5rem);text-shadow:0 0 15px #fbbf24;" id="score-display">0</p>
        <p class="samurai-font text-gray-400" style="font-size:clamp(0.5rem,1.4vw,0.65rem)">SCORE</p>
      </div>
      <!-- Right: lives + combo + equipped items -->
      <div class="text-right">
        <p id="lives-display" class="text-xl leading-none mb-1">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</p>
        <p class="samurai-font text-cyan-400 font-bold" style="font-size:clamp(0.55rem,1.6vw,0.75rem)">COMBO: <span id="combo-display">0x</span></p>
        <div style="display:flex;gap:4px;justify-content:flex-end;margin-top:3px;">
          <span id="hud-weapon" class="hud-weapon" title="Weapon"></span>
          <span id="hud-skin"   style="font-size:1rem;" title="Skin"></span>
          <span id="hud-clothes" style="font-size:1rem;" title="Clothes"></span>
        </div>
      </div>
    </div>
    <!-- Power-up pills -->
    <div class="absolute left-2 z-20 flex flex-col gap-1 pointer-events-none" style="top:72px;">
      <div id="shield-indicator"  class="powerup-pill bg-yellow-900 text-yellow-300 hidden">üõ°Ô∏è SHIELD</div>
      <div id="double-indicator"  class="powerup-pill bg-pink-900 text-pink-300 hidden">2Ô∏è‚É£ 2√ó PTS</div>
      <div id="slow-indicator"    class="powerup-pill bg-blue-900 text-blue-300 hidden">üê¢ SLOW</div>
    </div>
    <button id="pause-btn" class="pointer-events-auto">‚è∏ PAUSE</button>
    <div id="game-area" class="relative flex-1 w-full" style="touch-action:none;"></div>
    <!-- Game Over Modal -->
    <div id="game-over-modal" class="absolute inset-0 hidden items-center justify-center z-50 bg-black/88">
      <div class="bg-gray-900/95 border-2 border-red-600 p-6 rounded-2xl text-center mx-4 w-full max-w-sm">
        <h2 class="title-font text-resp-2xl text-red-500 red-glow mb-1">GAME OVER</h2>
        <div class="star-wrap mb-2" id="star-display">
          <span class="star" id="star-1">‚≠ê</span><span class="star" id="star-2">‚≠ê</span><span class="star" id="star-3">‚≠ê</span><span class="star" id="star-4">‚≠ê</span><span class="star" id="star-5">‚≠ê</span>
        </div>
        <p id="star-label" class="samurai-font text-yellow-400 text-xs mb-3" style="letter-spacing:1px;"></p>
        <div class="bg-gray-800/80 p-4 rounded-xl mb-4">
          <p class="text-gray-400 samurai-font text-xs">FINAL SCORE</p>
          <p id="go-score" class="samurai-font font-black text-yellow-400" style="font-size:clamp(2rem,6vw,3rem);">0</p>
        </div>
        <div class="grid grid-cols-3 gap-2 mb-4 text-xs">
          <div class="bg-gray-800/80 p-2 rounded-xl"><p class="text-gray-400">Enemies</p><p id="go-kills" class="text-cyan-400 font-bold text-base">0</p></div>
          <div class="bg-gray-800/80 p-2 rounded-xl"><p class="text-gray-400">Best Combo</p><p id="go-combo" class="text-pink-400 font-bold text-base">0x</p></div>
          <div class="bg-gray-800/80 p-2 rounded-xl"><p class="text-gray-400">Coins</p><p id="go-coins" class="text-yellow-400 font-bold text-base">0</p></div>
        </div>
        <div class="space-y-2">
          <button id="restart-game" class="samurai-font w-full py-3 bg-green-700 hover:bg-green-600 text-white rounded-xl font-bold touch-target text-resp-sm">üîÑ PLAY AGAIN</button>
          <button id="menu-from-game" class="samurai-font w-full py-3 bg-gray-700 hover:bg-gray-600 text-white rounded-xl font-bold touch-target text-resp-sm">‚Üê MAIN MENU</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ===== USABILITY GUIDE ===== -->
  <div id="screen-usability" class="screen game-bg-img screen-scroll" style="cursor:default;">
    <div class="bg-overlay"></div>
    <div class="relative z-10 flex flex-col items-center px-4 py-6 min-h-full">
      <div class="max-w-3xl w-full">
        <div class="flex justify-between items-center mb-6">
          <div>
            <h2 class="title-font text-resp-2xl text-yellow-400 gold-glow">USABILITY GUIDE</h2>
            <p class="text-gray-400 samurai-font text-xs mt-1">Principles powering this game's UX design</p>
          </div>
          <button id="back-from-usability" class="samurai-font px-5 py-2 bg-gray-800/80 hover:bg-gray-700 text-white rounded-lg touch-target text-resp-sm">‚Üê BACK</button>
        </div>
        <div class="bg-black/60 border border-yellow-700/40 rounded-2xl p-5 mb-6">
          <h3 class="samurai-font text-yellow-400 font-bold text-resp-md mb-2">üéØ What is Usability?</h3>
          <p class="text-gray-300 text-resp-sm leading-relaxed">Usability refers to how effectively, efficiently, and satisfyingly a user can interact with a system. In Samurai Slayer, every design decision ‚Äî from button placement to feedback animations ‚Äî is guided by three core usability principles.</p>
        </div>
        <div class="grid grid-cols-1 gap-4 mb-6" style="grid-template-columns:repeat(auto-fit,minmax(200px,1fr));">
          <div class="bg-black/60 border border-cyan-700/50 rounded-2xl p-5">
            <div class="usability-pill bg-cyan-900 text-cyan-300 mb-3">LEARNABILITY</div>
            <p class="text-gray-400 text-xs mb-3 italic">How easily new users understand the system</p>
            <ul class="space-y-2 text-resp-sm">
              <li class="flex gap-2 text-gray-300"><span class="text-cyan-400">‚ú¶</span><div><b class="text-white">Predictability</b> ‚Äî Enemies always follow the same arc pattern</div></li>
              <li class="flex gap-2 text-gray-300"><span class="text-cyan-400">‚ú¶</span><div><b class="text-white">Familiarity</b> ‚Äî Tap-to-slice gesture mirrors real swipe behavior</div></li>
              <li class="flex gap-2 text-gray-300"><span class="text-cyan-400">‚ú¶</span><div><b class="text-white">Consistency</b> ‚Äî Same visual language across all screens</div></li>
              <li class="flex gap-2 text-gray-300"><span class="text-cyan-400">‚ú¶</span><div><b class="text-white">Generalizability</b> ‚Äî Skills transfer across difficulty levels</div></li>
              <li class="flex gap-2 text-gray-300"><span class="text-cyan-400">‚ú¶</span><div><b class="text-white">Synthesizability</b> ‚Äî Score reflects all past actions clearly</div></li>
            </ul>
            <div class="mt-3 bg-cyan-900/20 border border-cyan-800/40 rounded-lg p-3"><p class="text-cyan-400 text-xs font-bold samurai-font mb-1">IN-GAME EXAMPLE</p><p class="text-gray-300 text-xs">The 3‚Üí2‚Üí1 countdown before gameplay gives players a predictable, learnable start ritual every session.</p></div>
          </div>
          <div class="bg-black/60 border border-green-700/50 rounded-2xl p-5">
            <div class="usability-pill bg-green-900 text-green-300 mb-3">FLEXIBILITY</div>
            <p class="text-gray-400 text-xs mb-3 italic">How many ways users can interact with the system</p>
            <ul class="space-y-2 text-resp-sm">
              <li class="flex gap-2 text-gray-300"><span class="text-green-400">‚ú¶</span><div><b class="text-white">Dialogue Initiative</b> ‚Äî Players choose persona &amp; difficulty</div></li>
              <li class="flex gap-2 text-gray-300"><span class="text-green-400">‚ú¶</span><div><b class="text-white">Multithreading</b> ‚Äî Pause, shop, and leaderboard run in parallel</div></li>
              <li class="flex gap-2 text-gray-300"><span class="text-green-400">‚ú¶</span><div><b class="text-white">Task Migrability</b> ‚Äî Switch persona before each new game</div></li>
              <li class="flex gap-2 text-gray-300"><span class="text-green-400">‚ú¶</span><div><b class="text-white">Substitutivity</b> ‚Äî Tap OR click ‚Äî works on any device</div></li>
              <li class="flex gap-2 text-gray-300"><span class="text-green-400">‚ú¶</span><div><b class="text-white">Customizability</b> ‚Äî Equip different skins, weapons, clothes</div></li>
            </ul>
            <div class="mt-3 bg-green-900/20 border border-green-800/40 rounded-lg p-3"><p class="text-green-400 text-xs font-bold samurai-font mb-1">IN-GAME EXAMPLE</p><p class="text-gray-300 text-xs">Power-up activations (Shield, 2√ó Points, Slow Time) give players multiple strategic paths during gameplay.</p></div>
          </div>
          <div class="bg-black/60 border border-orange-700/50 rounded-2xl p-5">
            <div class="usability-pill bg-orange-900 text-orange-300 mb-3">ROBUSTNESS</div>
            <p class="text-gray-400 text-xs mb-3 italic">How well the system supports user goals</p>
            <ul class="space-y-2 text-resp-sm">
              <li class="flex gap-2 text-gray-300"><span class="text-orange-400">‚ú¶</span><div><b class="text-white">Observability</b> ‚Äî Live score, combo, lives always visible</div></li>
              <li class="flex gap-2 text-gray-300"><span class="text-orange-400">‚ú¶</span><div><b class="text-white">Recoverability</b> ‚Äî Shield power-up absorbs one fatal hit</div></li>
              <li class="flex gap-2 text-gray-300"><span class="text-orange-400">‚ú¶</span><div><b class="text-white">Responsiveness</b> ‚Äî Instant slash feedback on every tap</div></li>
              <li class="flex gap-2 text-gray-300"><span class="text-orange-400">‚ú¶</span><div><b class="text-white">Task Conformance</b> ‚Äî Game saves stats and coins automatically</div></li>
            </ul>
            <div class="mt-3 bg-orange-900/20 border border-orange-800/40 rounded-lg p-3"><p class="text-orange-400 text-xs font-bold samurai-font mb-1">IN-GAME EXAMPLE</p><p class="text-gray-300 text-xs">Red damage flash + screen shake gives instant, observable feedback when a player loses a life ‚Äî supporting error awareness.</p></div>
          </div>
        </div>
        <div class="bg-black/60 border border-pink-700/40 rounded-2xl p-5 mb-6">
          <h3 class="samurai-font text-pink-400 font-bold text-resp-md mb-3">‚ö° Micro-Interactions in This Game</h3>
          <div class="grid gap-3" style="grid-template-columns:repeat(auto-fit,minmax(180px,1fr));">
            <div class="bg-pink-900/20 border border-pink-800/30 rounded-xl p-3"><p class="text-pink-300 font-bold text-xs samurai-font">‚öîÔ∏è WEAPON SLASH</p><p class="text-gray-300 text-xs mt-1">Each weapon shows a unique visual: katana = silver blade arc, flame = fire burst, frost = ice shards, dark = void explosion.</p></div>
            <div class="bg-pink-900/20 border border-pink-800/30 rounded-xl p-3"><p class="text-pink-300 font-bold text-xs samurai-font">üî¢ COMBO POPUP</p><p class="text-gray-300 text-xs mt-1">Bold animated text appears at enemy position when combo ‚â• 3 ‚Äî motivating chain kills.</p></div>
            <div class="bg-pink-900/20 border border-pink-800/30 rounded-xl p-3"><p class="text-pink-300 font-bold text-xs samurai-font">üí• DAMAGE FLASH</p><p class="text-gray-300 text-xs mt-1">Red vignette + screen shake on life loss ‚Äî visceral, immediate feedback.</p></div>
            <div class="bg-pink-900/20 border border-pink-800/30 rounded-xl p-3"><p class="text-pink-300 font-bold text-xs samurai-font">‚≠ê LEVEL UP BURST</p><p class="text-gray-300 text-xs mt-1">Full-screen gold glow with level text ‚Äî rewarding achievement signal.</p></div>
          </div>
        </div>
        <button id="back-from-usability-2" class="samurai-font w-full py-3 bg-gray-800/80 hover:bg-gray-700 text-white rounded-xl touch-target text-resp-sm mb-4">‚Üê BACK TO MENU</button>
      </div>
    </div>
  </div>

  <!-- ===== SHOP ===== -->
  <div id="screen-shop" class="screen game-bg-img screen-scroll" style="cursor:default;">
    <div class="bg-overlay"></div>
    <div class="relative z-10 flex flex-col px-4 py-6 min-h-full max-w-3xl mx-auto w-full">
      <div class="flex justify-between items-center mb-5">
        <h2 class="title-font text-resp-xl text-yellow-400 gold-glow">SHOP</h2>
        <button id="back-from-shop" class="samurai-font px-5 py-2 bg-gray-800/80 hover:bg-gray-700 text-white rounded-lg touch-target text-resp-sm">‚Üê BACK</button>
      </div>
      <!-- Profile preview in shop -->
      <div class="flex items-center gap-4 bg-black/60 border border-yellow-700/30 p-4 rounded-xl mb-5">
        <div style="width:60px;height:60px;border-radius:50%;border:3px solid #fbbf24;overflow:hidden;background:#111;flex-shrink:0;">
          <img id="shop-avatar-img" src="" alt="" style="width:100%;height:100%;object-fit:cover;" onerror="this.style.display='none';this.nextElementSibling.style.display='flex';">
          <div id="shop-avatar-fallback" style="display:none;width:100%;height:100%;align-items:center;justify-content:center;font-size:1.8rem;background:#1a1a2e;"></div>
        </div>
        <div class="flex-1">
          <p class="samurai-font text-yellow-300 font-bold" id="shop-username-display" style="font-size:0.85rem;"></p>
          <div style="display:flex;gap:6px;align-items:center;margin-top:4px;">
            <span id="shop-equipped-weapon" style="font-size:1.4rem;"></span>
            <span id="shop-equipped-skin" style="font-size:1.2rem;"></span>
            <span id="shop-equipped-clothes" style="font-size:1.2rem;"></span>
            <span class="text-gray-500 samurai-font" style="font-size:0.6rem;">‚Üê equipped</span>
          </div>
        </div>
        <div class="text-right">
          <p class="text-gray-400 samurai-font text-xs">COINS</p>
          <p class="samurai-font text-2xl text-yellow-400 font-bold" id="shop-coins">0</p>
          <span id="shop-rank" class="rank-badge rank-novice mt-1 block">NOVICE</span>
        </div>
      </div>

      <div class="mb-5">
        <h3 class="samurai-font text-cyan-400 text-resp-sm font-bold mb-3">üé® SKINS</h3>
        <div id="skins-container" class="grid gap-3" style="grid-template-columns:repeat(auto-fill,minmax(130px,1fr));"></div>
      </div>
      <div class="mb-5">
        <h3 class="samurai-font text-red-400 text-resp-sm font-bold mb-3">‚öîÔ∏è WEAPONS</h3>
        <div id="weapons-container" class="grid gap-3" style="grid-template-columns:repeat(auto-fill,minmax(130px,1fr));"></div>
      </div>
      <div class="mb-6">
        <h3 class="samurai-font text-purple-400 text-resp-sm font-bold mb-3">üëï CLOTHES</h3>
        <div id="clothes-container" class="grid gap-3" style="grid-template-columns:repeat(auto-fill,minmax(130px,1fr));"></div>
      </div>
    </div>
  </div>

  <!-- ===== LEADERBOARD ===== -->
  <div id="screen-leaderboard" class="screen game-bg-img screen-scroll" style="cursor:default;">
    <div class="bg-overlay"></div>
    <div class="relative z-10 flex flex-col px-4 py-6 min-h-full max-w-2xl mx-auto w-full">
      <div class="flex justify-between items-center mb-6">
        <h2 class="title-font text-resp-xl text-yellow-400 gold-glow">LEADERBOARD</h2>
        <button id="back-from-leaderboard" class="samurai-font px-5 py-2 bg-gray-800/80 hover:bg-gray-700 text-white rounded-lg touch-target text-resp-sm">‚Üê BACK</button>
      </div>
      <div id="leaderboard-list" class="space-y-3"></div>
    </div>
  </div>

  <!-- ===== SETTINGS ===== -->
  <div id="screen-settings" class="screen game-bg-img screen-scroll" style="cursor:default;">
    <div class="bg-overlay"></div>
    <div class="relative z-10 flex flex-col items-center px-4 py-6 min-h-full">
      <h2 class="title-font text-resp-xl text-yellow-400 gold-glow mb-6">SETTINGS</h2>
      <div class="bg-black/70 border border-yellow-700/30 p-6 rounded-2xl max-w-md w-full space-y-5 mb-6">

        <!-- Change User Button -->
        <div class="bg-yellow-900/20 border border-yellow-700/30 rounded-xl p-4">
          <p class="samurai-font text-yellow-400 font-bold text-xs mb-2">üë§ CURRENT PLAYER</p>
          <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;">
            <div style="width:44px;height:44px;border-radius:50%;border:2px solid #fbbf24;overflow:hidden;background:#111;flex-shrink:0;">
              <img id="settings-avatar-img" src="" alt="" style="width:100%;height:100%;object-fit:cover;" onerror="this.style.display='none';this.nextElementSibling.style.display='flex';">
              <div id="settings-avatar-fallback" style="display:none;width:100%;height:100%;align-items:center;justify-content:center;font-size:1.4rem;background:#1a1a2e;"></div>
            </div>
            <div>
              <p class="samurai-font text-white font-bold" id="settings-username-display" style="font-size:0.85rem;"></p>
              <span id="settings-rank-badge" class="rank-badge rank-novice" style="font-size:0.65rem;">NOVICE</span>
            </div>
          </div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
            <button onclick="changeUser()" class="samurai-font py-2 bg-yellow-700 hover:bg-yellow-600 text-black rounded-lg font-bold touch-target" style="font-size:0.72rem;">üîÑ SWITCH USER</button>
            <button onclick="openEditProfile(activeUID,null)" class="samurai-font py-2 bg-blue-800 hover:bg-blue-700 text-white rounded-lg font-bold touch-target" style="font-size:0.72rem;">‚úèÔ∏è EDIT PROFILE</button>
          </div>
        </div>

        <div class="flex items-center justify-between">
          <label class="text-white font-bold samurai-font text-resp-sm">üîä SOUND EFFECTS</label>
          <input type="checkbox" id="sound-toggle" class="w-6 h-6 touch-target" checked>
        </div>
        <div class="flex items-center justify-between">
          <label class="text-white font-bold samurai-font text-resp-sm">üéµ MUSIC</label>
          <input type="checkbox" id="music-toggle" class="w-6 h-6 touch-target" checked>
        </div>
        <hr class="border-gray-700">
        <div class="text-gray-400 text-xs space-y-2">
          <p class="font-bold text-white samurai-font text-xs">HOW TO PLAY</p>
          <p>‚Ä¢ Tap/click üëπ enemies to slice them</p>
          <p>‚Ä¢ AVOID üí£ bombs ‚Äî instant game over!</p>
          <p>‚Ä¢ 3 lives ‚Äî enemies that escape steal one</p>
          <p>‚Ä¢ Chain kills to build COMBO multiplier</p>
          <p>‚Ä¢ Every 15 kills = Level Up ‚≠ê</p>
          <p>‚Ä¢ Collect üõ°Ô∏è Shield, 2√ó Points, üê¢ Slow Time power-ups</p>
          <p>‚Ä¢ Equip weapons in Shop for unique slash effects!</p>
        </div>
      </div>
      <button id="back-from-settings" class="samurai-font px-8 py-3 bg-gray-800/80 hover:bg-gray-700 text-white rounded-xl touch-target text-resp-sm">‚Üê BACK</button>
    </div>
  </div>

</div>

<script>
// ============================
// MULTI-USER PROFILE SYSTEM
// ============================
const USER_PROFILES = {
  1: { uid:1, name:'SHADOW',   imgSrc:'userpersona1.png', fallback:'ü•∑', coins:0, highScore:0, rank:'Novice', skin:'default', weapon:'katana', clothes:'default', gamesPlayed:0, kills:0 },
  2: { uid:2, name:'BLAZE',    imgSrc:'userpersona2.jpg', fallback:'üí™', coins:0, highScore:0, rank:'Novice', skin:'default', weapon:'katana', clothes:'default', gamesPlayed:0, kills:0 },
  3: { uid:3, name:'GUARDIAN', imgSrc:'userpersona3.png', fallback:'üõ°Ô∏è', coins:0, highScore:0, rank:'Novice', skin:'default', weapon:'katana', clothes:'default', gamesPlayed:0, kills:0 }
};

let activeUID = null; // which persona is logged in
let pd = null;        // alias ‚Üí USER_PROFILES[activeUID]

// ============================
// SOUND
// ============================
function playSound(id){
  if(!gs.soundOn) return;
  const el=document.getElementById('sfx-'+id);
  if(!el) return; el.currentTime=0; el.play().catch(()=>{});
}
document.addEventListener('click',e=>{
  if(e.target.tagName==='BUTTON'||e.target.closest('button')) playSound('click');
});

let openBgmStarted=false;
function startOpenBgm(){
  if(!gs.musicOn) return;
  const o=document.getElementById('bgm-open'); o.volume=0.6; o.play().catch(()=>{});
}
function stopOpenBgm(){ const o=document.getElementById('bgm-open'); o.pause(); o.currentTime=0; }
function onFirstInteraction(){
  if(openBgmStarted) return; openBgmStarted=true; startOpenBgm();
  document.removeEventListener('click',onFirstInteraction);
  document.removeEventListener('touchstart',onFirstInteraction);
}
document.addEventListener('click',onFirstInteraction);
document.addEventListener('touchstart',onFirstInteraction);

// ============================
// STAR RATING
// ============================
const STAR_THRESHOLDS={ normal:[25,50,75,100,125], hard:[20,40,60,80,100], insane:[15,30,45,60,75] };
const STAR_LABELS=['KEEP TRAINING, WARRIOR...','‚≠ê APPRENTICE SAMURAI','‚≠ê‚≠ê SKILLED WARRIOR','‚≠ê‚≠ê‚≠ê MASTER SWORDSMAN','‚≠ê‚≠ê‚≠ê‚≠ê LEGENDARY BLADE','‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê IMMORTAL SAMURAI!'];
function calcStars(kills,difficulty){ const thr=STAR_THRESHOLDS[difficulty]||STAR_THRESHOLDS.normal; let s=0; for(let i=0;i<thr.length;i++){if(kills>=thr[i])s=i+1;} return s; }
function animateStars(count){
  for(let i=1;i<=5;i++) document.getElementById('star-'+i).classList.remove('lit');
  for(let i=1;i<=count;i++)(function(idx){setTimeout(()=>document.getElementById('star-'+idx).classList.add('lit'),idx*250);})(i);
  document.getElementById('star-label').textContent=STAR_LABELS[count]||STAR_LABELS[0];
}

// ============================
// CONSTANTS
// ============================
const PERSONAS={ ninja:{name:'Ninja',icon:'ü•∑',power:7,defense:6,speed:9}, berserker:{name:'Berserker',icon:'üí™',power:10,defense:5,speed:6}, guardian:{name:'Guardian',icon:'üõ°Ô∏è',power:6,defense:10,speed:5} };
const DIFFICULTIES={ normal:{name:'Normal',baseRate:1200,mult:1}, hard:{name:'Hard',baseRate:800,mult:1.5}, insane:{name:'Insane',baseRate:400,mult:2} };
const KILLS_PER_LEVEL=15;

const SHOP_ITEMS={
  skins:  [{id:'default',name:'Default',emoji:'üü£',cost:0},{id:'gold',name:'Gold',emoji:'üåü',cost:500},{id:'shadow',name:'Shadow',emoji:'üåë',cost:800},{id:'cyber',name:'Cyber',emoji:'ü§ñ',cost:1000}],
  weapons:[
    {id:'katana', name:'Katana', emoji:'‚öîÔ∏è', cost:0,   desc:'Silver blade arc'},
    {id:'flame',  name:'Flame',  emoji:'üî•', cost:600,  desc:'Fire burst strike'},
    {id:'frost',  name:'Frost',  emoji:'‚ùÑÔ∏è', cost:600,  desc:'Ice shard slash'},
    {id:'dark',   name:'Dark',   emoji:'üåë', cost:1200, desc:'Void explosion'}
  ],
  clothes:[{id:'default',name:'Default',emoji:'üëï',cost:0},{id:'armor',name:'Armor',emoji:'üõ°Ô∏è',cost:700},{id:'robe',name:'Robe',emoji:'üëî',cost:500},{id:'legend',name:'Legend',emoji:'üëë',cost:2000}]
};

// Weapon slash config
const WEAPON_SLASH={
  katana:{ type:'katana', color:'#aaf', sound:'slice' },
  flame: { type:'flame',  emoji:'üî•',   sound:'slice' },
  frost: { type:'frost',  emoji:'‚ùÑÔ∏è',   sound:'slice' },
  dark:  { type:'dark',   color:'#a855f7', sound:'slice' }
};

// ============================
// GAME STATE
// ============================
let gs={
  persona:'ninja', difficulty:'normal',
  score:0, coins:0, lives:3, combo:0, maxCombo:0, kills:0, level:1,
  hasShield:false, hasDouble:false, hasSlow:false,
  soundOn:true, musicOn:true
};
let gameActive=false, gamePaused=false;
let spawnTimer=null, enemies=[];

// ============================
// LOGIN SCREEN
// ============================
let loginSelectedUID=null;

function updateLoginPersonaStats(){
  for(let uid=1;uid<=3;uid++){
    const p=USER_PROFILES[uid];
    document.getElementById(`lp${uid}-name`).textContent=p.name;
    document.getElementById(`lp${uid}-score`).textContent='Best: '+p.highScore;
  }
}

// ‚îÄ‚îÄ EDIT PROFILE MODAL ‚îÄ‚îÄ
function openEditProfile(uid, evt){
  if(evt) evt.stopPropagation();
  const p=USER_PROFILES[uid];
  const modal=document.createElement('div');
  modal.id='edit-profile-modal';
  modal.style.cssText='position:fixed;inset:0;background:rgba(0,0,0,0.93);display:flex;align-items:center;justify-content:center;z-index:400;padding:16px;';
  const emojis=['ü•∑','üí™','üõ°Ô∏è','‚öîÔ∏è','üî•','‚ùÑÔ∏è','üë∫','üêâ'];
  const emojiButtons=emojis.map(em=>`<button class="emoji-pick-btn" data-emoji="${em}" style="font-size:1.5rem;padding:5px 8px;background:${p.fallback===em?'rgba(251,191,36,0.3)':'rgba(255,255,255,0.06)'};border:1px solid ${p.fallback===em?'#fbbf24':'rgba(255,255,255,0.15)'};border-radius:8px;cursor:pointer;">${em}</button>`).join('');
  modal.innerHTML=`
    <div style="background:linear-gradient(135deg,#0f0f1e,#1a1a2e);border:2px solid rgba(251,191,36,0.5);border-radius:20px;padding:clamp(18px,4vw,28px);max-width:360px;width:100%;position:relative;">
      <button id="close-edit-modal" style="position:absolute;top:12px;right:12px;width:30px;height:30px;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.3);border-radius:50%;color:#fff;font-size:0.9rem;font-weight:bold;cursor:pointer;display:flex;align-items:center;justify-content:center;">‚úï</button>
      <h3 class="samurai-font text-yellow-400 font-bold text-center mb-4" style="font-size:0.95rem;">‚úèÔ∏è EDIT PROFILE #${uid}</h3>
      <div style="display:flex;justify-content:center;margin-bottom:16px;">
        <div style="width:80px;height:80px;border-radius:50%;border:3px solid #fbbf24;overflow:hidden;background:#111;">
          <img id="edit-avatar-preview" src="${p.imgSrc}" alt="" style="width:100%;height:100%;object-fit:cover;" onerror="this.style.display='none';this.nextElementSibling.style.display='flex';">
          <div id="edit-avatar-fallback" style="display:none;width:100%;height:100%;align-items:center;justify-content:center;font-size:2rem;background:#1a1a2e;">${p.fallback}</div>
        </div>
      </div>
      <div style="margin-bottom:12px;">
        <label class="samurai-font text-gray-400" style="font-size:0.68rem;display:block;margin-bottom:5px;">üë§ DISPLAY NAME</label>
        <input id="edit-name-input" type="text" maxlength="16" value="${p.name}" style="width:100%;background:rgba(255,255,255,0.08);border:1px solid rgba(251,191,36,0.3);border-radius:8px;color:#fff;padding:9px 12px;font-family:'Orbitron',sans-serif;font-size:0.82rem;outline:none;">
      </div>
      <div style="margin-bottom:12px;">
        <label class="samurai-font text-gray-400" style="font-size:0.68rem;display:block;margin-bottom:5px;">üé≠ AVATAR ICON (if image missing)</label>
        <div style="display:flex;gap:8px;flex-wrap:wrap;">${emojiButtons}</div>
      </div>
      <div style="background:rgba(0,0,0,0.4);border:1px solid rgba(255,255,255,0.1);border-radius:10px;padding:10px;margin-bottom:14px;">
        <p class="samurai-font text-gray-500" style="font-size:0.6rem;margin-bottom:6px;">üìä STATS</p>
        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:6px;text-align:center;">
          <div><p class="text-gray-400" style="font-size:0.58rem;">Best Score</p><p class="samurai-font text-yellow-400 font-bold" style="font-size:0.82rem;">${p.highScore}</p></div>
          <div><p class="text-gray-400" style="font-size:0.58rem;">Total Kills</p><p class="samurai-font text-cyan-400 font-bold" style="font-size:0.82rem;">${p.kills||0}</p></div>
          <div><p class="text-gray-400" style="font-size:0.58rem;">Games</p><p class="samurai-font text-pink-400 font-bold" style="font-size:0.82rem;">${p.gamesPlayed||0}</p></div>
        </div>
      </div>
      <details style="margin-bottom:14px;">
        <summary class="samurai-font text-red-500 cursor-pointer" style="font-size:0.65rem;">‚ö†Ô∏è DANGER ZONE ‚Äî Reset Profile</summary>
        <div style="margin-top:8px;background:rgba(180,0,0,0.1);border:1px solid rgba(220,38,38,0.3);border-radius:8px;padding:10px;">
          <p class="text-gray-400" style="font-size:0.6rem;margin-bottom:8px;">Permanently erase all stats, coins and progress for this profile.</p>
          <button id="reset-profile-btn" class="samurai-font w-full py-2 text-white rounded-lg font-bold" style="background:#7f1d1d;font-size:0.7rem;border:none;cursor:pointer;">üóëÔ∏è RESET THIS PROFILE</button>
        </div>
      </details>
      <button id="save-edit-btn" class="samurai-font w-full py-3 text-white rounded-xl font-bold touch-target" style="background:linear-gradient(to right,#0e7490,#1d4ed8);font-size:0.82rem;border:none;cursor:pointer;">üíæ SAVE CHANGES</button>
    </div>
  `;
  document.body.appendChild(modal);
  let chosenEmoji=p.fallback;
  modal.querySelectorAll('.emoji-pick-btn').forEach(btn=>{
    btn.addEventListener('click',ev=>{ ev.stopPropagation();
      chosenEmoji=btn.dataset.emoji;
      modal.querySelectorAll('.emoji-pick-btn').forEach(b=>{ b.style.background='rgba(255,255,255,0.06)'; b.style.borderColor='rgba(255,255,255,0.15)'; });
      btn.style.background='rgba(251,191,36,0.3)'; btn.style.borderColor='#fbbf24';
      document.getElementById('edit-avatar-fallback').textContent=chosenEmoji;
    });
  });
  document.getElementById('reset-profile-btn').addEventListener('click',ev=>{ ev.stopPropagation();
    if(!confirm('Reset all stats for '+USER_PROFILES[uid].name+'?')) return;
    Object.assign(USER_PROFILES[uid],{coins:0,highScore:0,rank:'Novice',kills:0,gamesPlayed:0,bestStars_normal:0,bestStars_hard:0,bestStars_insane:0,skin:'default',weapon:'katana',clothes:'default'});
    modal.remove(); updateLoginPersonaStats();
  });
  document.getElementById('save-edit-btn').addEventListener('click',ev=>{ ev.stopPropagation();
    const newName=document.getElementById('edit-name-input').value.trim().toUpperCase();
    if(newName) USER_PROFILES[uid].name=newName;
    USER_PROFILES[uid].fallback=chosenEmoji;
    modal.remove(); updateLoginPersonaStats();
    if(pd&&pd.uid===uid){ pd=USER_PROFILES[uid]; updateMainMenu(); updateShopUI && updateShopUI(); }
  });
  document.getElementById('close-edit-modal').addEventListener('click',ev=>{ ev.stopPropagation(); modal.remove(); });
  modal.addEventListener('click',ev=>{ if(ev.target===modal) modal.remove(); });
}

function selectLoginPersona(uid){
  loginSelectedUID=uid;
  document.querySelectorAll('#login-persona-grid .user-persona-card').forEach(c=>{
    c.classList.toggle('selected',parseInt(c.dataset.uid)===uid);
    const ring=c.querySelector('div:first-child');
    if(parseInt(c.dataset.uid)===uid){ ring.style.borderColor='#ff006e'; ring.style.boxShadow='0 0 12px rgba(255,0,110,0.5)'; }
    else { ring.style.borderColor='rgba(251,191,36,0.4)'; ring.style.boxShadow='none'; }
  });
  const input=document.getElementById('login-username');
  input.value=USER_PROFILES[uid].name;
  updateLoginPreview();
}

function updateLoginPreview(){
  const input=document.getElementById('login-username');
  const btn=document.getElementById('login-confirm-btn');
  const valid=loginSelectedUID!==null && input.value.trim().length>0;
  btn.disabled=!valid; btn.style.opacity=valid?'1':'0.5';
  // Live update persona name
  if(loginSelectedUID) USER_PROFILES[loginSelectedUID].name=input.value.trim()||USER_PROFILES[loginSelectedUID].name;
}

function confirmLogin(){
  if(!loginSelectedUID) return;
  const name=document.getElementById('login-username').value.trim();
  if(!name) return;
  USER_PROFILES[loginSelectedUID].name=name.toUpperCase();
  activeUID=loginSelectedUID;
  pd=USER_PROFILES[activeUID];
  showScreen('main');
  updateMainMenu();
}

// ============================
// SCREEN MANAGER
// ============================
function showScreen(id){
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  const el=document.getElementById('screen-'+id);
  if(el) el.classList.add('active');
  if(id==='gameplay'){ stopOpenBgm(); }
  else if(gs.musicOn && openBgmStarted){ const o=document.getElementById('bgm-open'); if(o.paused) o.play().catch(()=>{}); }
}

// ============================
// NAVIGATION
// ============================
document.getElementById('btn-play').addEventListener('click',()=>showScreen('character'));
document.getElementById('btn-usability').addEventListener('click',()=>showScreen('usability'));
document.getElementById('btn-shop').addEventListener('click',()=>{ updateShopUI(); renderShop(); showScreen('shop'); });
document.getElementById('btn-leaderboard').addEventListener('click',()=>{ renderLeaderboard(); showScreen('leaderboard'); });
document.getElementById('btn-settings').addEventListener('click',()=>{ updateSettingsUI(); showScreen('settings'); });
document.getElementById('back-from-character').addEventListener('click',()=>showScreen('main'));
document.getElementById('back-from-difficulty').addEventListener('click',()=>showScreen('character'));
document.getElementById('back-from-usability').addEventListener('click',()=>showScreen('main'));
document.getElementById('back-from-usability-2').addEventListener('click',()=>showScreen('main'));
document.getElementById('back-from-shop').addEventListener('click',()=>showScreen('main'));
document.getElementById('back-from-leaderboard').addEventListener('click',()=>showScreen('main'));
document.getElementById('back-from-settings').addEventListener('click',()=>showScreen('main'));

// ============================
// CHARACTER SELECT
// ============================
document.querySelectorAll('.persona-card').forEach(card=>{
  const pick=()=>{ document.querySelectorAll('.persona-card').forEach(c=>c.classList.remove('selected')); card.classList.add('selected'); gs.persona=card.dataset.persona; };
  card.addEventListener('click',pick);
  const btn=card.querySelector('button');
  if(btn) btn.addEventListener('click',e=>{ e.stopPropagation(); pick(); showScreen('difficulty'); });
});

// ============================
// DIFFICULTY
// ============================
document.querySelectorAll('.difficulty-btn').forEach(btn=>
  btn.addEventListener('click',()=>{ gs.difficulty=btn.dataset.difficulty; showInstructions(); })
);

// ============================
// INSTRUCTIONS (with X close)
// ============================
function showInstructions(){
  const ov=document.createElement('div'); ov.className='instructions-overlay';
  ov.innerHTML=`
    <div style="background:linear-gradient(135deg,#0f0f1e,#1a1a2e);border:2px solid rgba(251,191,36,0.5);border-radius:16px;padding:clamp(16px,4vw,28px);max-width:480px;width:100%;margin:auto;position:relative;">
      <!-- X close button -->
      <button id="close-inst" style="position:absolute;top:12px;right:12px;width:32px;height:32px;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.3);border-radius:50%;color:#fff;font-size:1rem;font-weight:bold;cursor:pointer;display:flex;align-items:center;justify-content:center;z-index:10;">‚úï</button>
      <h2 class="title-font text-resp-xl text-yellow-400 gold-glow text-center mb-1">HOW TO PLAY</h2>
      <p class="samurai-font text-gray-400 text-center mb-4" style="font-size:0.7rem;">READ CAREFULLY, WARRIOR</p>
      <div class="space-y-2 mb-5 text-resp-sm" style="max-height:55vh;overflow-y:auto;padding-right:4px;">
        <div class="flex gap-3 items-start"><span class="text-2xl">üëπ</span><p class="text-gray-300"><b class="text-yellow-300">Click/Tap enemies</b> as they fly up to earn points.</p></div>
        <div class="flex gap-3 items-start"><span class="text-2xl">üí£</span><p class="text-gray-300"><b class="text-red-400">AVOID bombs!</b> Clicking one ends the game instantly.</p></div>
        <div class="flex gap-3 items-start"><span class="text-2xl">‚ù§Ô∏è</span><p class="text-gray-300">You have <b class="text-red-400">3 lives</b>. Enemies that escape steal a life.</p></div>
        <div class="flex gap-3 items-start"><span class="text-2xl">üî•</span><p class="text-gray-300">Chain kills to build a <b class="text-pink-400">COMBO MULTIPLIER</b> for massive points.</p></div>
        <div class="flex gap-3 items-start"><span class="text-2xl">‚≠ê</span><p class="text-gray-300">Every <b class="text-cyan-400">${KILLS_PER_LEVEL} kills</b> = Level Up! Enemies get faster each level.</p></div>
        <div class="flex gap-3 items-start"><span class="text-2xl">üí´</span><p class="text-gray-300">Random <b class="text-green-400">power-ups</b>: üõ°Ô∏è Shield absorbs damage, 2Ô∏è‚É£ doubles points, üê¢ slows spawns.</p></div>
        <div class="flex gap-3 items-start"><span class="text-2xl">‚öîÔ∏è</span><p class="text-gray-300">Your equipped <b class="text-yellow-400">weapon</b> shows a unique slash animation on every hit!</p></div>
        <div class="flex gap-3 items-start"><span class="text-2xl">üí∞</span><p class="text-gray-300">Earn <b class="text-yellow-400">coins</b> from kills to unlock Shop items.</p></div>
        <div class="flex gap-3 items-start"><span class="text-2xl">‚è∏</span><p class="text-gray-300">Use the <b class="text-white">PAUSE</b> button anytime to freeze the game.</p></div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
        <button id="skip-inst" class="samurai-font py-3 bg-gray-700 hover:bg-gray-600 text-white rounded-xl font-bold touch-target" style="font-size:clamp(0.7rem,2vw,0.9rem);">SKIP</button>
        <button id="ready-inst" class="samurai-font py-3 text-white rounded-xl font-bold touch-target" style="background:linear-gradient(to right,#dc2626,#fbbf24);font-size:clamp(0.7rem,2vw,0.9rem);">READY ‚Üí START!</button>
      </div>
    </div>
  `;
  document.body.appendChild(ov);
  const launch=()=>{ ov.remove(); showCountdown(); };
  const cancel=()=>{ ov.remove(); };
  document.getElementById('close-inst').addEventListener('click',cancel);
  document.getElementById('skip-inst').addEventListener('click',launch);
  document.getElementById('ready-inst').addEventListener('click',launch);
}

// ============================
// COUNTDOWN
// ============================
function showCountdown(){
  showScreen('gameplay');
  setupGameHUD();
  const ov=document.createElement('div'); ov.className='countdown-overlay'; document.body.appendChild(ov);
  const steps=[{t:'3',c:'#ef4444'},{t:'2',c:'#f97316'},{t:'1',c:'#22c55e'},{t:'START!',c:'#fbbf24'}];
  let i=0;
  function next(){ if(i>=steps.length){ov.remove();startGameLoop();return;} const s=steps[i++]; ov.innerHTML=`<div class="countdown-number" style="color:${s.c};text-shadow:0 0 30px ${s.c};">${s.t}</div>`; setTimeout(next,i===steps.length?700:850); }
  next();
}

// ============================
// GAME SETUP
// ============================
function setupGameHUD(){
  gs.score=0; gs.lives=3; gs.combo=0; gs.maxCombo=0; gs.kills=0; gs.level=1; gs.coins=0;
  gs.hasShield=gs.hasDouble=gs.hasSlow=false; enemies=[];
  document.getElementById('hud-persona').textContent=PERSONAS[gs.persona].name.toUpperCase();
  document.getElementById('hud-diff').textContent=DIFFICULTIES[gs.difficulty].name.toUpperCase();
  document.getElementById('hud-level').textContent='1';
  document.getElementById('game-area').innerHTML='';
  document.getElementById('game-over-modal').style.display='none';
  document.getElementById('hud-username').textContent=pd?pd.name:'SAMURAI';

  // Set HUD avatar
  if(pd){
    const img=document.getElementById('hud-avatar-img');
    const fallback=document.getElementById('hud-avatar-fallback');
    img.src=pd.imgSrc; img.style.display='block';
    fallback.textContent=pd.fallback; fallback.style.display='none';
    img.onerror=function(){ this.style.display='none'; fallback.style.display='flex'; };

    // equipped items in HUD
    const w=SHOP_ITEMS.weapons.find(x=>x.id===pd.weapon)||SHOP_ITEMS.weapons[0];
    const s=SHOP_ITEMS.skins.find(x=>x.id===pd.skin)||SHOP_ITEMS.skins[0];
    const c=SHOP_ITEMS.clothes.find(x=>x.id===pd.clothes)||SHOP_ITEMS.clothes[0];
    document.getElementById('hud-weapon').textContent=w.emoji;
    document.getElementById('hud-skin').textContent=s.emoji;
    document.getElementById('hud-clothes').textContent=c.emoji;
  }

  setLevelBg(1); updateHUD();
}

function setLevelBg(lvl){ document.getElementById('level-overlay').className=`absolute inset-0 lvl-bg-${Math.min(lvl,5)} transition-all duration-1000`; }
function spawnRate(){ return Math.max(200,DIFFICULTIES[gs.difficulty].baseRate-(gs.level-1)*80); }

// ============================
// GAME LOOP
// ============================
function startGameLoop(){
  gameActive=true; gamePaused=false;
  if(gs.musicOn){ const bgm=document.getElementById('bgm'); bgm.currentTime=0; bgm.play().catch(()=>{}); }
  if(spawnTimer) clearInterval(spawnTimer);
  spawnTimer=setInterval(()=>{ if(gameActive&&!gamePaused) spawnEnemy(); },spawnRate());
  spawnEnemy();
}

// ============================
// SPAWN
// ============================
function spawnEnemy(){
  if(!gameActive||gamePaused) return;
  const area=document.getElementById('game-area'); if(!area) return;
  const isBomb=Math.random()<0.15;
  const el=document.createElement('div');
  el.style.cssText=`position:absolute;font-size:clamp(2.5rem,7vw,3.5rem);pointer-events:auto;z-index:10;bottom:-70px;touch-action:none;`;
  el.textContent=isBomb?'üí£':'üëπ';
  el.dataset.bomb=isBomb?'1':'0';
  el.dataset.eid=Date.now()+Math.random();
  el.dataset.sliced='0';
  const aW=area.offsetWidth||300;
  const startX=Math.random()*Math.max(aW-80,100);
  el.style.left=startX+'px';
  area.appendChild(el);
  enemies.push({el,eid:el.dataset.eid,sliced:false});
  const handleSlice=e=>{ e.preventDefault(); e.stopPropagation(); sliceEnemy(el); };
  el.addEventListener('click',handleSlice);
  el.addEventListener('touchstart',handleSlice,{passive:false});
  animateArc(el,startX);
}

function animateArc(el,startX){
  const area=document.getElementById('game-area'); if(!area) return;
  const t0=performance.now();
  const dur=Math.max(1600,2600-(gs.level-1)*100);
  const drift=(Math.random()-0.5)*140;
  const aH=area.offsetHeight||500;
  const peak=aH*(0.45+Math.random()*0.35);
  function frame(now){
    if(!el.parentElement) return;
    if(gamePaused){ requestAnimationFrame(frame); return; }
    const p=Math.min((now-t0)/dur,1);
    if(p>=1){ if(el.dataset.bomb==='0'&&el.dataset.sliced==='0') takeDamage(); el.remove(); return; }
    el.style.bottom=(Math.sin(p*Math.PI)*peak)+'px';
    el.style.left=(startX+drift*p)+'px';
    requestAnimationFrame(frame);
  }
  requestAnimationFrame(frame);
}

// ============================
// SLICE
// ============================
function sliceEnemy(el){
  const d=enemies.find(e=>e.el===el); if(!d||d.sliced) return;
  d.sliced=true; el.dataset.sliced='1';
  if(el.dataset.bomb==='1'){ playSound('bomb'); gameActive=false; showYouLose(()=>endGame()); return; }
  playSound('slice');
  gs.combo++; gs.maxCombo=Math.max(gs.maxCombo,gs.combo); gs.kills++;
  let pts=10*DIFFICULTIES[gs.difficulty].mult;
  if(gs.combo>2) pts*=gs.combo;
  if(gs.hasDouble) pts*=2;
  gs.score+=Math.round(pts); gs.coins+=Math.floor(pts/20);
  if(gs.combo>=3){ showCombo(el,gs.combo); playSound('combo'); }
  if(Math.random()<0.1) activatePowerup();
  const newLvl=Math.floor(gs.kills/KILLS_PER_LEVEL)+1;
  if(newLvl>gs.level){ gs.level=newLvl; triggerLevelUp(); }

  // ‚îÄ‚îÄ WEAPON SLASH EFFECT ‚îÄ‚îÄ
  createWeaponSlash(el);

  el.style.opacity='0'; setTimeout(()=>el.remove(),150); updateHUD();
}

// ============================
// WEAPON SLASH EFFECTS
// ============================
function createWeaponSlash(el){
  const area=document.getElementById('game-area');
  const weapon=pd?pd.weapon:'katana';
  const x=parseFloat(el.style.left)||50;
  const bot=parseFloat(el.style.bottom)||50;

  if(weapon==='katana'){
    // Silver sword arc
    const s=document.createElement('div');
    s.className='slash-katana';
    s.style.left=(x-10)+'px'; s.style.bottom=(bot+20)+'px';
    s.style.transform='rotate(-20deg)';
    area.appendChild(s);
    setTimeout(()=>s.remove(),500);
    // Secondary arc (cross slash)
    const s2=document.createElement('div');
    s2.className='slash-katana';
    s2.style.left=(x+5)+'px'; s2.style.bottom=(bot+10)+'px';
    s2.style.width='55px'; s2.style.transform='rotate(25deg)';
    s2.style.animationDelay='0.05s';
    area.appendChild(s2);
    setTimeout(()=>s2.remove(),550);
  } else if(weapon==='flame'){
    // Fire burst
    const emojis=['üî•','üí•','üî•'];
    emojis.forEach((e,i)=>{
      const s=document.createElement('div');
      s.className='slash-flame';
      s.textContent=e;
      s.style.left=(x+(-20+i*20))+'px'; s.style.bottom=(bot+(i*10))+'px';
      s.style.animationDelay=(i*0.06)+'s';
      area.appendChild(s);
      el.classList.add('flame-aura');
      setTimeout(()=>s.remove(),650);
    });
  } else if(weapon==='frost'){
    // Ice shard burst
    const emojis=['‚ùÑÔ∏è','üå®Ô∏è','‚ùÑÔ∏è'];
    emojis.forEach((e,i)=>{
      const s=document.createElement('div');
      s.className='slash-frost';
      s.textContent=e;
      s.style.left=(x+(-18+i*18))+'px'; s.style.bottom=(bot+(i*8))+'px';
      s.style.animationDelay=(i*0.07)+'s';
      area.appendChild(s);
      el.classList.add('frost-aura');
      setTimeout(()=>s.remove(),700);
    });
  } else if(weapon==='dark'){
    // Void explosion
    const s=document.createElement('div');
    s.className='slash-dark';
    s.style.left=(x-10)+'px'; s.style.bottom=(bot-5)+'px';
    area.appendChild(s);
    el.classList.add('dark-aura');
    // Dark energy tendrils
    for(let i=0;i<4;i++){
      const t=document.createElement('div');
      t.style.cssText=`position:absolute;width:40px;height:3px;border-radius:2px;background:linear-gradient(90deg,#a855f7,transparent);transform-origin:left center;transform:rotate(${i*45}deg);left:${x+15}px;bottom:${bot+20}px;animation:katanaSlash 0.5s ${i*0.04}s forwards;z-index:20;opacity:0.8;`;
      area.appendChild(t);
      setTimeout(()=>t.remove(),600);
    }
    setTimeout(()=>s.remove(),550);
  }
}

function showCombo(el,c){
  const area=document.getElementById('game-area');
  const p=document.createElement('div'); p.className='combo-pop text-pink-400 font-bold';
  p.textContent=`${c}√ó COMBO!`; p.style.left=el.style.left; p.style.bottom=el.style.bottom;
  area.appendChild(p); setTimeout(()=>p.remove(),800);
}

// ============================
// DAMAGE
// ============================
function takeDamage(){
  if(gs.hasShield) return;
  gs.lives--; gs.combo=0; showDamageFlash(); updateHUD(); checkGameOver();
}
function showDamageFlash(){
  const f=document.createElement('div'); f.className='damage-flash'; document.body.appendChild(f); setTimeout(()=>f.remove(),500);
  const gp=document.getElementById('screen-gameplay'); gp.classList.remove('shaking'); void gp.offsetWidth; gp.classList.add('shaking'); setTimeout(()=>gp.classList.remove('shaking'),400);
}

// ============================
// LEVEL UP
// ============================
function triggerLevelUp(){
  playSound('levelup'); setLevelBg(gs.level);
  document.getElementById('hud-level').textContent=gs.level;
  clearInterval(spawnTimer); spawnTimer=setInterval(()=>{ if(gameActive&&!gamePaused) spawnEnemy(); },spawnRate());
  const b=document.createElement('div'); b.className='levelup-burst';
  b.innerHTML=`<div class="levelup-text">‚≠ê LEVEL ${gs.level}!</div>`;
  document.body.appendChild(b); setTimeout(()=>b.remove(),1400);
}

// ============================
// YOU LOSE
// ============================
function showYouLose(cb){
  const ov=document.createElement('div'); ov.className='you-lose-overlay';
  ov.innerHTML='<div class="you-lose-text">YOU LOSE!</div>';
  document.body.appendChild(ov); setTimeout(()=>{ ov.remove(); cb(); },2000);
}

// ============================
// POWER-UPS
// ============================
function activatePowerup(){
  playSound('powerup');
  const types=['shield','double','slow']; const t=types[Math.floor(Math.random()*types.length)]; const D=5000;
  if(t==='shield'){
    gs.hasShield=true; document.getElementById('shield-indicator').classList.remove('hidden');
    setTimeout(()=>{ gs.hasShield=false; document.getElementById('shield-indicator').classList.add('hidden'); },D);
  } else if(t==='double'){
    gs.hasDouble=true; document.getElementById('double-indicator').classList.remove('hidden');
    setTimeout(()=>{ gs.hasDouble=false; document.getElementById('double-indicator').classList.add('hidden'); },D);
  } else {
    gs.hasSlow=true; document.getElementById('slow-indicator').classList.remove('hidden');
    clearInterval(spawnTimer); spawnTimer=setInterval(()=>{ if(gameActive&&!gamePaused) spawnEnemy(); },spawnRate()*2);
    setTimeout(()=>{ gs.hasSlow=false; document.getElementById('slow-indicator').classList.add('hidden'); clearInterval(spawnTimer); spawnTimer=setInterval(()=>{ if(gameActive&&!gamePaused) spawnEnemy(); },spawnRate()); },D);
  }
}

// ============================
// HUD
// ============================
function updateHUD(){
  document.getElementById('score-display').textContent=gs.score;
  document.getElementById('combo-display').textContent=gs.combo+'x';
  document.getElementById('lives-display').textContent='‚ù§Ô∏è'.repeat(Math.max(0,gs.lives))+'üñ§'.repeat(Math.max(0,3-gs.lives));
}
function checkGameOver(){ if(gs.lives<=0){ gameActive=false; showYouLose(()=>endGame()); } }

// ============================
// GAME OVER
// ============================
function endGame(){
  gameActive=false; if(spawnTimer) clearInterval(spawnTimer);
  const bgm=document.getElementById('bgm'); bgm.pause(); bgm.currentTime=0;
  const stars=calcStars(gs.kills,gs.difficulty);
  if(pd){
    const bestKey='bestStars_'+gs.difficulty;
    pd[bestKey]=Math.max(pd[bestKey]||0,stars);
    if(gs.score>5000) pd.rank='Legendary';
    else if(gs.score>2000) pd.rank='Master';
    else if(gs.score>500) pd.rank='Warrior';
    else pd.rank='Novice';
    pd.coins=(pd.coins||0)+gs.coins;
    pd.highScore=Math.max(pd.highScore||0,gs.score);
    pd.gamesPlayed=(pd.gamesPlayed||0)+1;
    pd.kills=(pd.kills||0)+gs.kills;
  }
  document.getElementById('go-score').textContent=gs.score;
  document.getElementById('go-kills').textContent=gs.kills;
  document.getElementById('go-combo').textContent=gs.maxCombo+'x';
  document.getElementById('go-coins').textContent=gs.coins;
  const m=document.getElementById('game-over-modal'); m.style.display='flex';
  setTimeout(()=>animateStars(calcStars(gs.kills,gs.difficulty)),400);
  if(gs.musicOn&&openBgmStarted) setTimeout(()=>{ const o=document.getElementById('bgm-open'); o.currentTime=0; o.play().catch(()=>{}); },600);
  updateMainMenu();
}

document.getElementById('restart-game').addEventListener('click',()=>{ document.getElementById('game-over-modal').style.display='none'; showInstructions(); });
document.getElementById('menu-from-game').addEventListener('click',()=>{ if(spawnTimer) clearInterval(spawnTimer); gameActive=false; showScreen('main'); });

// ============================
// PAUSE
// ============================
document.getElementById('pause-btn').addEventListener('click',()=>{
  if(!gameActive) return; gamePaused=true; clearInterval(spawnTimer); document.getElementById('bgm').pause();
  const ov=document.createElement('div'); ov.className='pause-overlay'; ov.id='pause-ov';
  ov.innerHTML=`
    <div style="background:linear-gradient(135deg,#0f0f1e,#1a1a2e);border:2px solid rgba(251,191,36,0.5);border-radius:20px;padding:clamp(24px,5vw,40px);text-align:center;min-width:260px;">
      <h2 class="title-font text-resp-xl text-yellow-400 gold-glow mb-6">PAUSED</h2>
      <div style="display:flex;flex-direction:column;gap:12px;">
        <button id="resume-btn" class="samurai-font py-4 bg-green-700 hover:bg-green-600 text-white rounded-xl font-bold touch-target" style="font-size:clamp(0.8rem,2vw,1rem);">‚ñ∂ RESUME</button>
        <button id="pause-menu-btn" class="samurai-font py-4 bg-gray-700 hover:bg-gray-600 text-white rounded-xl font-bold touch-target" style="font-size:clamp(0.8rem,2vw,1rem);">‚Üê MAIN MENU</button>
      </div>
    </div>
  `;
  document.body.appendChild(ov);
  document.getElementById('resume-btn').addEventListener('click',()=>{ ov.remove(); gamePaused=false; if(gs.musicOn) document.getElementById('bgm').play().catch(()=>{}); spawnTimer=setInterval(()=>{ if(gameActive&&!gamePaused) spawnEnemy(); },spawnRate()); });
  document.getElementById('pause-menu-btn').addEventListener('click',()=>{ ov.remove(); gameActive=gamePaused=false; if(spawnTimer) clearInterval(spawnTimer); showScreen('main'); });
});

// ============================
// SHOP
// ============================
function updateShopUI(){
  if(!pd) return;
  document.getElementById('shop-coins').textContent=pd.coins;
  const r=document.getElementById('shop-rank');
  r.textContent=(pd.rank||'Novice').toUpperCase();
  r.className=`rank-badge rank-${(pd.rank||'novice').toLowerCase()}`;
  document.getElementById('shop-username-display').textContent=pd.name;

  // Avatar in shop
  const img=document.getElementById('shop-avatar-img');
  const fallback=document.getElementById('shop-avatar-fallback');
  img.src=pd.imgSrc; img.style.display='block';
  fallback.textContent=pd.fallback; fallback.style.display='none';
  img.onerror=function(){ this.style.display='none'; fallback.style.display='flex'; };

  // Equipped preview
  const w=SHOP_ITEMS.weapons.find(x=>x.id===pd.weapon)||SHOP_ITEMS.weapons[0];
  const s=SHOP_ITEMS.skins.find(x=>x.id===pd.skin)||SHOP_ITEMS.skins[0];
  const c=SHOP_ITEMS.clothes.find(x=>x.id===pd.clothes)||SHOP_ITEMS.clothes[0];
  document.getElementById('shop-equipped-weapon').textContent=w.emoji;
  document.getElementById('shop-equipped-skin').textContent=s.emoji;
  document.getElementById('shop-equipped-clothes').textContent=c.emoji;
}

function renderShop(){
  if(!pd) return;
  renderSection(SHOP_ITEMS.skins,  document.getElementById('skins-container'),   'skin',   pd.skin,    'skin-active');
  renderSection(SHOP_ITEMS.weapons,document.getElementById('weapons-container'), 'weapon', pd.weapon,  'weapon-active');
  renderSection(SHOP_ITEMS.clothes,document.getElementById('clothes-container'), 'clothes',pd.clothes, 'clothes-active');
}

function renderSection(items,container,type,equipped,activeClass){
  container.innerHTML='';
  items.forEach(item=>{
    const canAfford=pd.coins>=item.cost||item.cost===0;
    const isEquipped=equipped===item.id;
    const d=document.createElement('div');
    d.className=`shop-item bg-black/60 border-2 p-3 text-center ${isEquipped?'border-yellow-500 equipped ':' border-gray-700'} ${!canAfford?'opacity-40':''}`;
    d.innerHTML=`
      <div style="font-size:2.2rem;margin-bottom:6px;">${item.emoji}</div>
      <p class="samurai-font text-white font-bold" style="font-size:0.7rem;margin-bottom:2px;">${item.name}</p>
      ${item.desc?`<p class="text-gray-500" style="font-size:0.58rem;margin-bottom:4px;">${item.desc}</p>`:''}
      <p class="text-yellow-400 font-bold" style="font-size:0.75rem;">${item.cost===0?'FREE':item.cost+' üí∞'}</p>
      ${isEquipped?'<p class="text-green-400 samurai-font mt-1" style="font-size:0.65rem;">‚úì EQUIPPED</p>':''}
      ${canAfford&&!isEquipped?`<button class="equip-btn samurai-font mt-2 w-full py-1 rounded font-bold touch-target" style="background:#0e7490;color:#fff;font-size:0.65rem;" data-type="${type}" data-id="${item.id}" data-cost="${item.cost}">EQUIP</button>`:''}
      ${!canAfford&&!isEquipped?`<p class="text-red-500 samurai-font mt-1" style="font-size:0.6rem;">Need ${item.cost-pd.coins} üí∞</p>`:''}
    `;
    container.appendChild(d);
  });
}

document.addEventListener('click',e=>{
  if(e.target.classList.contains('equip-btn')&&pd){
    const type=e.target.dataset.type;
    const id=e.target.dataset.id;
    const cost=parseInt(e.target.dataset.cost)||0;
    // Deduct coins only if not free
    if(cost>0&&pd.coins<cost) return;
    pd[type]=id;
    updateShopUI(); renderShop();
  }
});

// ============================
// LEADERBOARD
// ============================
function renderLeaderboard(){
  const demos=[
    {name:'Shadow_Blade',score:8420,rank:'Legendary'},
    {name:'NeonSamurai',score:6100,rank:'Legendary'},
    {name:'CrimsonStrike',score:3800,rank:'Master'},
    {name:'IronGuardian',score:2500,rank:'Master'},
    {name:'SwiftNinja99',score:900,rank:'Warrior'}
  ];
  // Add all user profiles
  for(let uid=1;uid<=3;uid++){
    const p=USER_PROFILES[uid];
    if(p.highScore>0) demos.push({name:p.name,score:p.highScore,rank:p.rank||'Novice'});
  }
  demos.sort((a,b)=>b.score-a.score);
  const list=document.getElementById('leaderboard-list'); list.innerHTML='';
  demos.slice(0,10).forEach((p,i)=>{
    const medal=i===0?'ü•á':i===1?'ü•à':i===2?'ü•â':'';
    const row=document.createElement('div');
    row.style.cssText='background:rgba(0,0,0,0.6);border-left:4px solid #fbbf24;border-radius:10px;padding:12px 16px;display:flex;justify-content:space-between;align-items:center;';
    row.innerHTML=`
      <div><p class="text-white font-bold samurai-font" style="font-size:clamp(0.75rem,2vw,0.9rem);">${medal} #${i+1}</p><p class="text-gray-400" style="font-size:0.75rem;">${p.name}</p></div>
      <div style="text-align:right;"><p class="text-yellow-400 font-bold samurai-font" style="font-size:clamp(1rem,3vw,1.3rem);">${p.score}</p><span class="rank-badge rank-${(p.rank||'novice').toLowerCase()}">${p.rank||'Novice'}</span></div>
    `;
    list.appendChild(row);
  });
}

// ============================
// SETTINGS
// ============================
function updateSettingsUI(){
  if(!pd) return;
  document.getElementById('settings-username-display').textContent=pd.name;
  const img=document.getElementById('settings-avatar-img');
  const fallback=document.getElementById('settings-avatar-fallback');
  img.src=pd.imgSrc; img.style.display='block';
  fallback.textContent=pd.fallback; fallback.style.display='none';
  img.onerror=function(){ this.style.display='none'; fallback.style.display='flex'; };
  const rb=document.getElementById('settings-rank-badge');
  rb.textContent=(pd.rank||'NOVICE').toUpperCase();
  rb.className=`rank-badge rank-${(pd.rank||'novice').toLowerCase()}`;
}

function changeUser(){
  // Go back to login screen
  loginSelectedUID=null;
  updateLoginPersonaStats();
  showScreen('login');
}

document.getElementById('sound-toggle').addEventListener('change',e=>gs.soundOn=e.target.checked);
document.getElementById('music-toggle').addEventListener('change',e=>{
  gs.musicOn=e.target.checked;
  const o=document.getElementById('bgm-open'); const b=document.getElementById('bgm');
  if(gs.musicOn){ if(openBgmStarted&&!gameActive) o.play().catch(()=>{}); if(gameActive&&!gamePaused) b.play().catch(()=>{}); }
  else { o.pause(); b.pause(); }
});

// ============================
// MAIN MENU
// ============================
function updateMainMenu(){
  if(!pd){ document.getElementById('player-preview').innerHTML='<p class="text-gray-500 samurai-font" style="font-size:0.75rem;">Not logged in</p>'; return; }
  const bestN=pd.bestStars_normal||0, bestH=pd.bestStars_hard||0, bestI=pd.bestStars_insane||0;
  function starsHtml(n){ let s=''; for(let i=1;i<=5;i++) s+=`<span style="font-size:0.9rem;filter:${i<=n?'none':'grayscale(1) brightness(0.3)'}">‚≠ê</span>`; return s; }
  document.getElementById('player-preview').innerHTML=`
    <div onclick="openEditProfile(activeUID,null)"
      style="display:inline-flex;flex-direction:column;align-items:center;cursor:pointer;
             background:rgba(0,0,0,0.45);border:1.5px solid rgba(251,191,36,0.35);
             border-radius:16px;padding:10px 18px;transition:border-color 0.2s,box-shadow 0.2s;
             position:relative;"
      onmouseover="this.style.borderColor='#fbbf24';this.style.boxShadow='0 0 14px rgba(251,191,36,0.35)';"
      onmouseout="this.style.borderColor='rgba(251,191,36,0.35)';this.style.boxShadow='none';">

      <!-- Edit hint badge -->
      <div style="position:absolute;top:-8px;right:-8px;background:#fbbf24;color:#000;border-radius:20px;
                  padding:2px 8px;font-family:'Orbitron',sans-serif;font-size:0.55rem;font-weight:700;
                  white-space:nowrap;">‚úèÔ∏è EDIT</div>

      <div style="display:flex;align-items:center;gap:10px;margin-bottom:6px;">
        <div style="width:48px;height:48px;border-radius:50%;border:2px solid #fbbf24;overflow:hidden;background:#111;flex-shrink:0;">
          <img src="${pd.imgSrc}" alt="" style="width:100%;height:100%;object-fit:cover;" onerror="this.style.display='none';this.nextElementSibling.style.display='flex';">
          <div style="display:none;width:100%;height:100%;align-items:center;justify-content:center;font-size:1.6rem;background:#1a1a2e;">${pd.fallback}</div>
        </div>
        <div style="text-align:left;">
          <p class="samurai-font text-yellow-400 font-bold" style="font-size:clamp(0.7rem,2vw,0.9rem);">${pd.name}</p>
          <p class="text-gray-400" style="font-size:0.72rem;">Best: <span class="text-yellow-300 font-bold">${pd.highScore}</span></p>
          <span class="rank-badge rank-${(pd.rank||'novice').toLowerCase()}" style="margin-top:2px;display:inline-block;">${(pd.rank||'NOVICE').toUpperCase()}</span>
        </div>
      </div>
      <div style="display:flex;justify-content:center;gap:6px;margin-bottom:6px;">
        <span style="font-size:1.1rem;" title="Weapon">${(SHOP_ITEMS.weapons.find(x=>x.id===pd.weapon)||SHOP_ITEMS.weapons[0]).emoji}</span>
        <span style="font-size:1.1rem;" title="Skin">${(SHOP_ITEMS.skins.find(x=>x.id===pd.skin)||SHOP_ITEMS.skins[0]).emoji}</span>
        <span style="font-size:1.1rem;" title="Clothes">${(SHOP_ITEMS.clothes.find(x=>x.id===pd.clothes)||SHOP_ITEMS.clothes[0]).emoji}</span>
      </div>
      <div style="font-size:0.65rem;text-align:left;">
        <div class="flex items-center gap-2"><span class="text-green-400 samurai-font" style="width:50px;">NORMAL</span>${starsHtml(bestN)}</div>
        <div class="flex items-center gap-2"><span class="text-orange-400 samurai-font" style="width:50px;">HARD</span>${starsHtml(bestH)}</div>
        <div class="flex items-center gap-2"><span class="text-red-400 samurai-font" style="width:50px;">INSANE</span>${starsHtml(bestI)}</div>
      </div>
    </div>
  `;
}

// ============================
// INIT
// ============================
updateLoginPersonaStats();
showScreen('login');
</script>
</body>
</html>
